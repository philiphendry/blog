---
author: philiphendry
comments: true
date: 2011-04-08 11:58:55+00:00
layout: post
slug: create-sql-scripts-for-data-in-a-table
title: Create SQL Scripts for Data in a table
wordpress_id: 352
categories:
- T-SQL
---

On occasion I want to get data from a table and into a script – particularly when I want to create a deployment script for standing data that needs to be migrated between servers. Rather than hand-craft it this last time I’ve created the script below which, when given the name of a table, generates a union’d list of select statements that represent the data. With a slight modification this list can then be selected into a temporary table then joined back to the original in an update/insert to create a script that automatically maintains the data.

 

There are some caveats to this script though :

 

  
  * You have to delete the first ‘union’ in the resulting SQL.
   
  * It doesn’t handle dates correctly and potentially some other data types – I did write this in a hurry!
 

  
    
    <div><span style="color:#008080;"> 1</span> <span style="color:#0000FF;">declare</span><span style="color:#000000;"> </span><span style="color:#008000;">@tablename</span><span style="color:#000000;"> </span><span style="color:#0000FF;">nvarchar</span><span style="color:#000000;">(</span><span style="color:#FF00FF;">max</span><span style="color:#000000;">)
    </span><span style="color:#008080;"> 2</span> <span style="color:#000000;"></span><span style="color:#0000FF;">set</span><span style="color:#000000;"> </span><span style="color:#008000;">@tablename</span><span style="color:#000000;"> </span><span style="color:#808080;">=</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">testtable</span><span style="color:#FF0000;">'</span><span style="color:#000000;">
    </span><span style="color:#008080;"> 3</span> <span style="color:#000000;">
    </span><span style="color:#008080;"> 4</span> <span style="color:#000000;"></span><span style="color:#0000FF;">if</span><span style="color:#000000;"> </span><span style="color:#808080;">not</span><span style="color:#000000;"> </span><span style="color:#808080;">exists</span><span style="color:#000000;"> ( </span><span style="color:#0000FF;">select</span><span style="color:#000000;"> </span><span style="color:#FF0000;">[</span><span style="color:#FF0000;">TABLE_NAME</span><span style="color:#FF0000;">]</span><span style="color:#000000;"> </span><span style="color:#0000FF;">from</span><span style="color:#000000;"> INFORMATION_SCHEMA.TABLES </span><span style="color:#0000FF;">where</span><span style="color:#000000;"> </span><span style="color:#FF0000;">[</span><span style="color:#FF0000;">TABLE_NAME</span><span style="color:#FF0000;">]</span><span style="color:#000000;"> </span><span style="color:#808080;">=</span><span style="color:#000000;"> </span><span style="color:#008000;">@tablename</span><span style="color:#000000;"> )
    </span><span style="color:#008080;"> 5</span> <span style="color:#000000;"></span><span style="color:#0000FF;">begin</span><span style="color:#000000;">
    </span><span style="color:#008080;"> 6</span> <span style="color:#000000;">    </span><span style="color:#0000FF;">declare</span><span style="color:#000000;"> </span><span style="color:#008000;">@message</span><span style="color:#000000;"> </span><span style="color:#0000FF;">nvarchar</span><span style="color:#000000;">(</span><span style="color:#FF00FF;">max</span><span style="color:#000000;">)
    </span><span style="color:#008080;"> 7</span> <span style="color:#000000;">    </span><span style="color:#0000FF;">set</span><span style="color:#000000;"> </span><span style="color:#008000;">@message</span><span style="color:#000000;"> </span><span style="color:#808080;">=</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">The table </span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#008000;">@tablename</span><span style="color:#000000;"> </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;"> does not exist</span><span style="color:#FF0000;">'</span><span style="color:#000000;">
    </span><span style="color:#008080;"> 8</span> <span style="color:#000000;">    </span><span style="color:#0000FF;">raiserror</span><span style="color:#000000;"> ( </span><span style="color:#008000;">@message</span><span style="color:#000000;">, </span><span style="color:#800000;font-weight:bold;">18</span><span style="color:#000000;">, </span><span style="color:#800000;font-weight:bold;">0</span><span style="color:#000000;"> );
    </span><span style="color:#008080;"> 9</span> <span style="color:#000000;">    </span><span style="color:#0000FF;">return</span><span style="color:#000000;">;
    </span><span style="color:#008080;">10</span> <span style="color:#000000;"></span><span style="color:#0000FF;">end</span><span style="color:#000000;">
    </span><span style="color:#008080;">11</span> <span style="color:#000000;">
    </span><span style="color:#008080;">12</span> <span style="color:#000000;"></span><span style="color:#0000FF;">declare</span><span style="color:#000000;"> </span><span style="color:#008000;">@sql</span><span style="color:#000000;"> </span><span style="color:#0000FF;">nvarchar</span><span style="color:#000000;">(</span><span style="color:#FF00FF;">max</span><span style="color:#000000;">)
    </span><span style="color:#008080;">13</span> <span style="color:#000000;"></span><span style="color:#0000FF;">set</span><span style="color:#000000;"> </span><span style="color:#008000;">@sql</span><span style="color:#000000;"> </span><span style="color:#808080;">=</span><span style="color:#000000;"> </span><span style="color:#FF0000;">''</span><span style="color:#000000;">
    </span><span style="color:#008080;">14</span> <span style="color:#000000;">
    </span><span style="color:#008080;">15</span> <span style="color:#000000;"></span><span style="color:#0000FF;">declare</span><span style="color:#000000;"> </span><span style="color:#008000;">@newline</span><span style="color:#000000;"> </span><span style="color:#0000FF;">nvarchar</span><span style="color:#000000;">(</span><span style="color:#800000;font-weight:bold;">2</span><span style="color:#000000;">)
    </span><span style="color:#008080;">16</span> <span style="color:#000000;"></span><span style="color:#0000FF;">set</span><span style="color:#000000;"> </span><span style="color:#008000;">@newline</span><span style="color:#000000;"> </span><span style="color:#808080;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">char</span><span style="color:#000000;">(</span><span style="color:#800000;font-weight:bold;">13</span><span style="color:#000000;">) </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#0000FF;">char</span><span style="color:#000000;">(</span><span style="color:#800000;font-weight:bold;">10</span><span style="color:#000000;">)
    </span><span style="color:#008080;">17</span> <span style="color:#000000;">
    </span><span style="color:#008080;">18</span> <span style="color:#000000;"></span><span style="color:#0000FF;">select</span><span style="color:#000000;"> </span><span style="color:#008000;">@sql</span><span style="color:#000000;"> </span><span style="color:#808080;">=</span><span style="color:#000000;"> </span><span style="color:#008000;">@sql</span><span style="color:#000000;"> 
    </span><span style="color:#008080;">19</span> <span style="color:#000000;">    </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF00FF;">case</span><span style="color:#000000;"> </span><span style="color:#0000FF;">when</span><span style="color:#000000;"> ORDINAL_POSITION </span><span style="color:#808080;">></span><span style="color:#000000;"> </span><span style="color:#800000;font-weight:bold;">1</span><span style="color:#000000;"> </span><span style="color:#0000FF;">then</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;"> + </span><span style="color:#FF0000;">''</span><span style="color:#FF0000;">, </span><span style="color:#FF0000;">''</span><span style="color:#FF0000;"> + </span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#0000FF;">else</span><span style="color:#000000;"> </span><span style="color:#FF0000;">''</span><span style="color:#000000;"> </span><span style="color:#0000FF;">end</span><span style="color:#000000;"> 
    </span><span style="color:#008080;">20</span> <span style="color:#000000;">    </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF00FF;">case</span><span style="color:#000000;"> </span><span style="color:#0000FF;">when</span><span style="color:#000000;"> IS_NULLABLE </span><span style="color:#808080;">=</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">YES</span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#0000FF;">then</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">isnull(</span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#0000FF;">else</span><span style="color:#000000;"> </span><span style="color:#FF0000;">''</span><span style="color:#000000;"> </span><span style="color:#0000FF;">end</span><span style="color:#000000;">
    </span><span style="color:#008080;">21</span> <span style="color:#000000;">    </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF00FF;">case</span><span style="color:#000000;"> </span><span style="color:#0000FF;">when</span><span style="color:#000000;"> NUMERIC_SCALE </span><span style="color:#0000FF;">is</span><span style="color:#000000;"> </span><span style="color:#808080;">not</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;"> </span><span style="color:#808080;">or</span><span style="color:#000000;"> DATA_TYPE </span><span style="color:#808080;">=</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">bit</span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#0000FF;">then</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">convert(nvarchar, </span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#0000FF;">else</span><span style="color:#000000;"> </span><span style="color:#FF0000;">''</span><span style="color:#000000;"> </span><span style="color:#0000FF;">end</span><span style="color:#000000;">
    </span><span style="color:#008080;">22</span> <span style="color:#000000;">    </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF00FF;">case</span><span style="color:#000000;"> </span><span style="color:#0000FF;">when</span><span style="color:#000000;"> CHARACTER_MAXIMUM_LENGTH </span><span style="color:#0000FF;">is</span><span style="color:#000000;"> </span><span style="color:#808080;">not</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;"> </span><span style="color:#0000FF;">then</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;"> </span><span style="color:#FF0000;">''''''''</span><span style="color:#FF0000;"> + </span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#0000FF;">else</span><span style="color:#000000;"> </span><span style="color:#FF0000;">''</span><span style="color:#000000;"> </span><span style="color:#0000FF;">end</span><span style="color:#000000;">
    </span><span style="color:#008080;">23</span> <span style="color:#000000;">    </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">[</span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#808080;">+</span><span style="color:#000000;"> isc.COLUMN_NAME </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">]</span><span style="color:#FF0000;">'</span><span style="color:#000000;">
    </span><span style="color:#008080;">24</span> <span style="color:#000000;">    </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF00FF;">case</span><span style="color:#000000;"> </span><span style="color:#0000FF;">when</span><span style="color:#000000;"> CHARACTER_MAXIMUM_LENGTH </span><span style="color:#0000FF;">is</span><span style="color:#000000;"> </span><span style="color:#808080;">not</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;"> </span><span style="color:#0000FF;">then</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;"> + </span><span style="color:#FF0000;">'''''''''</span><span style="color:#000000;"> </span><span style="color:#0000FF;">else</span><span style="color:#000000;"> </span><span style="color:#FF0000;">''</span><span style="color:#000000;"> </span><span style="color:#0000FF;">end</span><span style="color:#000000;">
    </span><span style="color:#008080;">25</span> <span style="color:#000000;">    </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF00FF;">case</span><span style="color:#000000;"> </span><span style="color:#0000FF;">when</span><span style="color:#000000;"> NUMERIC_SCALE </span><span style="color:#0000FF;">is</span><span style="color:#000000;"> </span><span style="color:#808080;">not</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;"> </span><span style="color:#808080;">or</span><span style="color:#000000;"> DATA_TYPE </span><span style="color:#808080;">=</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">bit</span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#0000FF;">then</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">)</span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#0000FF;">else</span><span style="color:#000000;"> </span><span style="color:#FF0000;">''</span><span style="color:#000000;"> </span><span style="color:#0000FF;">end</span><span style="color:#000000;">
    </span><span style="color:#008080;">26</span> <span style="color:#000000;">    </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF00FF;">case</span><span style="color:#000000;"> </span><span style="color:#0000FF;">when</span><span style="color:#000000;"> IS_NULLABLE </span><span style="color:#808080;">=</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">YES</span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#0000FF;">then</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">, </span><span style="color:#FF0000;">''</span><span style="color:#FF0000;">null</span><span style="color:#FF0000;">''</span><span style="color:#FF0000;">)</span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#0000FF;">else</span><span style="color:#000000;"> </span><span style="color:#FF0000;">''</span><span style="color:#000000;"> </span><span style="color:#0000FF;">end</span><span style="color:#000000;">
    </span><span style="color:#008080;">27</span> <span style="color:#000000;">    </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;"> + </span><span style="color:#FF0000;">''</span><span style="color:#FF0000;"> as [</span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#808080;">+</span><span style="color:#000000;"> COLUMN_NAME </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">]</span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF0000;">''''</span><span style="color:#000000;">
    </span><span style="color:#008080;">28</span> <span style="color:#000000;">    </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#008000;">@newline</span><span style="color:#000000;">
    </span><span style="color:#008080;">29</span> <span style="color:#000000;"></span><span style="color:#0000FF;">from</span><span style="color:#000000;"> INFORMATION_SCHEMA.COLUMNS isc
    </span><span style="color:#008080;">30</span> <span style="color:#000000;"></span><span style="color:#0000FF;">where</span><span style="color:#000000;">
    </span><span style="color:#008080;">31</span> <span style="color:#000000;">    isc.TABLE_NAME </span><span style="color:#808080;">=</span><span style="color:#000000;"> </span><span style="color:#008000;">@tablename</span><span style="color:#000000;">
    </span><span style="color:#008080;">32</span> <span style="color:#000000;"></span><span style="color:#0000FF;">order</span><span style="color:#000000;"> </span><span style="color:#0000FF;">by</span><span style="color:#000000;">
    </span><span style="color:#008080;">33</span> <span style="color:#000000;">    ORDINAL_POSITION
    </span><span style="color:#008080;">34</span> <span style="color:#000000;">
    </span><span style="color:#008080;">35</span> <span style="color:#000000;"></span><span style="color:#0000FF;">set</span><span style="color:#000000;"> </span><span style="color:#008000;">@sql</span><span style="color:#000000;"> </span><span style="color:#808080;">=</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">select </span><span style="color:#FF0000;">''</span><span style="color:#FF0000;">union select </span><span style="color:#FF0000;">''</span><span style="color:#FF0000;"> + </span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#008000;">@sql</span><span style="color:#000000;"> </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;"> from [</span><span style="color:#FF0000;">'</span><span style="color:#000000;"> </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#008000;">@tablename</span><span style="color:#000000;"> </span><span style="color:#808080;">+</span><span style="color:#000000;"> </span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">]</span><span style="color:#FF0000;">'</span><span style="color:#000000;">
    </span><span style="color:#008080;">36</span> <span style="color:#000000;"></span><span style="color:#0000FF;">exec</span><span style="color:#000000;"> sp_executesql </span><span style="color:#008000;">@sql</span></div>
